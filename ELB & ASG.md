# ELB & ASG - High Availability and Scalability 

### Elastic Load Balancing
- server or set of servers that forward traffic to multiple servers downstream
- seemingly handle failures
- SSL termination
- stickiness with cookies
- high avail across zones
- separate high public traffic
- manage load balancer
- aws handles upgrades config
- coss less to set up
- health checks
	- done on a port and route
	- crucial
	- if no 200 code then unhealthy, traffic will not be sent there
- **4 kinds of LB on aws
	- Classic Load Balancer (deprecated)
	- Application Load Balancer
	- Network Load Balancer
	- Gateway Load Balancer

#### Application Load Balancer v2
- HTTP only - layer 7
- route to multiple HTTP app across machines
	- grouped in target groups
- multiple apps on same instances
- support redriect
- http/2 and websocket support
- routing table to different target groups
- routing based on query strings and headers
- *great fit for micro services and container based
- has port mapping feat to redirect to dynamic port in ECS
**Target Groups
- can be in front of
	- EC2 instances
	- ECS task managed by ECS itself
	- Lambda functions 
	- IP addresses - must be private
fixed hostname with ALB
server doesn't seee ip of client directly

## ALB vs NLB vs GLB
**application load balancer = http/https traffic
network load balancer = ultra high performance / low latency
gateway load balancer = security for intrusion detection/firewalls, analyze traffic

#### Network Load Balancer
- forward TCP & UDP - lower level 
- when you see udp or tcp think NLB
- handle million requests per seconds
- one static IP per AZ - supports elastic IP
- **if you see TCP UDP or Static IP - think NLB
- Not included in free tier
- possible to have NLB in front of ALB = fixed IP with all rules of handling HTTP traffic
- **Health checks performed by NLB TG - supports TCP/HTTP/HTTPS

#### Gateway Load Balancer
- use case = all traffic to go through firewall, intrusion detection, deep packet inspection, payload manipulation = all at network level
- all user traffic goes through GLB - then spread across all virtual appliances in TG = send back to GLB = then forward to application
- operates at level 3 = lowest level LB compared to NLB ALB
- single entry/exit 
- GENEVE protocol 6081
- third party can be ec2 or private ips

#### Elastic Load Balancer
- **Sticky session
	- possible to have same client always redirected to same instance behind a LB
	- cookie is sent as part of the request
	- use case = ensure user doesn't lose session data
	- may bring imbalances to load
	- *Two types of cookies
		- **App based cookies
		- custom cookies
			- generated by app itself
			- cookie specified individ each TG
		- application cookies
			- generated by LB
			- cookie name is AWSALBAPP
		- **Duration based cookies
			- cookie generated by load balancer
			- name is AWSALB for ALB, AWSELB for CLB
- **Cross zone load balancing
	- each LB instance will distribute evenly across all registered instances in all AZ
	- ALB - cross zone is enabled by default = can be disabled at target group level
	- NLB & GLB - cross zone disabled by default
- **SSL/TLS Certs
	- allows traffic between client and LB to be encrypted in transit = in flight encryption
	- secure sockets layer
	- transport layer security
	- TLS is modern day use
	- clients can use SNI to specify hostname they reach
	- **Server Name Indication
		- load multi certs onto one web server
		- works on cloud front ALB and NLB
		- required client to indicate hostname in SSL handshake, server will find correct cert
- **Connection Draining
	- Called a de-registration delay in ALB & NLB
	- stops sending new requests to ec2 which is de registering
	- time to complete in flight requests while instance is de registering or unhealthy
	- waits for existing connections to finish, new connection sent to all other instances
#### Auto Scaling Groups ASG
- goal of ASG scale out to match an increased load
- or scale in to match decreased load
- define min and max number of instances
- auto reg new instances to LB
- if an instance is deemed unhealthy a new one is created in it's place
- min, desired and max capacities 
- can be used with ELB, elb can check health of instances
- launch template
	- config on how to launch new instances
- **Scaling Policies
	- possible to scale in and out based on cloud watch alarms
	- alarm is triggered by a metric, can be custom
	- Dynamic Scaling
		- target tracking
	- Simple / step scaling
		- cloud watch alarm triggered
	- Scheduled Scaling
		- based on known usage
	- Predictive scaling
		- forecast load and schedule ahead of time
	- Metrics to scale on
		- CPU utillization
		- RequestCountPerTarget - make sure number of requests are stable
		- average network in/out - if app is network bound
		- any custom metric used in cloud watch
	- Scaling cool down 
		- after scaling activity there is 300 second cool down period
		- during this period ASG will not launch or terminate new instances
		- use a ready to use AMI to reduce config time for instances to serve requests faster and faster scaling 
